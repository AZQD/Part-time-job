<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>kalichimall, join us to make money by your second-hand goods. </title>
    <meta name="keywords" content="kalichi,mall, kalichimall,vehicle,sedan,suv,digtal,cellphone,computer,watch,bulding,family,house,office,life goods,clothes,shoes,furniture,sell,buy,second,free">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no" />
    <meta http-equiv="x-dns-prefetch-control" content="on" />
    <meta name="format-detection"content="telephone=no"/>
    <meta name="format-detection" content="email=no"/>
    <link class="favicon" href="" rel="shortcut icon" type="image/x-icon"/>
    <link rel="stylesheet" href="css/bootstraptc.min.css">
    <link rel="stylesheet" href="css/ppublic.min.css">
    <link rel="stylesheet" href="css/swiper.min.css">
    <link rel="stylesheet" href="css/login.css">
</head>
<body>
<section class="commonPopBox1" style="display: none;">
    <div class="commonPop">
        <h3 class="title"></h3>
        <p class="detailTip"></p>
        <div class="confirmBox">
            <span class="confirmBtn">OK</span>
        </div>
    </div>
</section>
<section class="container">

    <aside class="row headerBox">
        <div class="col-xs-4 col-sm-4 left"><img class="logo" src="image/index/logo.png"></div>
        <div class="col-xs-4 col-sm-4"></div>
        <div class="col-xs-4 col-sm-4 right">
            <img class="search" src="image/index/search.png">
            <span class="logout" style="display: none;">Logout</span>
        </div>
    </aside>

    <aside class="row loginRegisterBox">
        <div class="row loginRegister">
            <div class="col-xs-12 col-sm-12 loginWrap" style="display: block;">
                <div class="row loginBox">
                    <div class="col-xs-12 col-sm-12 loginTitle">
                        <span class="gang">|</span>&nbsp;<span class="">SIGN IN</span>
                    </div>
                    <div class="col-xs-12 col-sm-12 loginPhone">
                        <img class="phoneImg" src="image/loginRegister/phoneImg.png"><input class="phoneText" id="loginPhone" type="text" placeholder="Cellphone Number"/>
                    </div>
                    <div class="col-xs-12 col-sm-12 loginPassword">
                        <img class="passwordImg" src="image/loginRegister/passwordImg.png"><input class="passwordText" id="loginPassword" type="password" placeholder="Password"/>
                    </div>
                    <div class="col-xs-7 col-sm-7 loginBtn" id="loginBtn">Sign in</div>
                    <div class="col-xs-1 col-sm-1"></div>
                    <div class="col-xs-4 col-sm-4 loginBtn" id="goToRegister">Sign up</div>
                    <!--<div class="col-xs-12 col-sm-12 loginBottom">
                        <img class="passwordImg" src="image/loginRegister/login1.png">&nbsp;&nbsp;
                        <img class="passwordImg" src="image/loginRegister/login2.png">
                    </div>-->

                </div>
            </div>
            <div class="col-xs-12 col-sm-12 registerWrap" style="display: none;">
                <div class="row registerBox">
                    <div class="col-xs-12 col-sm-12 registerTitle">
                        <span class="gang">|</span>&nbsp;<span class="">SIGN UP</span>
                    </div>
                    <div class="col-xs-12 col-sm-12 registerPhone">
                        <img class="phoneImg" src="image/loginRegister/phoneImg.png"><input id="registerPhone" class="phoneText" type="text" placeholder="Cellphone Number(09xxxxxxxx)"><span id="registerTip">Cellphone number is not correct.</span>
                    </div>
                    <div class="col-xs-12 col-sm-12 registerPassword">
                        <img class="passwordImg" src="image/loginRegister/passwordImg.png"><input id="registerPassword" class="passwordText" type="text" placeholder="Password">
                    </div>
                    <!--<div class="col-xs-12 col-sm-12 registerDrag">
                        Drag Block To Right
                        <img class="dragImg" src="image/loginRegister/dragBlock.png">
                    </div>-->

                    <!--#darg-->
                    <div class="col-xs-12 col-sm-12 registerDragNew">
                        <div id="drag"></div>
                    </div>
                    <div class="col-xs-4 col-sm-4 registerBtn" id="goToLogin">Sign in</div>
                    <div class="col-xs-1 col-sm-1"></div>
                    <div class="col-xs-7 col-sm-7 registerBtn" id="registerBtn">Sign up</div>

                </div>
            </div>
            <div class="col-xs-12 col-sm-12 findPsw"><a href="reset_password.html">Forgot your password?</a></div>
        </div>
    </aside>
</section>
<script type="text/javascript" src="js/jquery-3.0.0.min.js"></script>
<script type="text/javascript" src="js/drag.js"></script>
<script type="text/javascript" src="js/swiper.min.js"></script>
<script type="text/javascript" src="js/base64.js"></script>
<script type="text/javascript" src="js/jsencrypt.js"></script>
<script type="text/javascript" src="js/public.js"></script>
<script type="text/javascript">

    $(function(){

        //登陆/注册切换
        $('#goToRegister').unbind('click').click(function(){
            $('.loginRegisterBox .loginRegister .loginWrap').hide();
            $('.loginRegisterBox .loginRegister .registerWrap').show();
        });
        $('#goToLogin').unbind('click').click(function(){
            $('.loginRegisterBox .loginRegister .loginWrap').show();
            $('.loginRegisterBox .loginRegister .registerWrap').hide();
        });

        var b = new Base64_new();
        var publicKey = "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC5jmTSO5V9ILlphRYdfFk4M2Rko/Ur22h43SxkFcGcj9Vkuew5P65XJPQtJesvY37UmU7zXWsqT/i4Evo2gaYu9Eu/fgutkP9KE4yKh4Ruk/pYC+hyNFVIK21kl4o8cfV9cKumydj2WXgmuywX8UQiVIfbKuvEAw+RVvPjBt9UqQIDAQAB";
        var encrypt = new JSEncrypt();
        encrypt.setPublicKey(publicKey);



        function loginFun(){
            var loginPhone = b.encode($.trim($('#loginPhone').val()));
            var loginPassword = b.encode($.trim($('#loginPassword').val()));
            var authKey = encrypt.encrypt("user="+ loginPhone +"&pass="+ loginPassword);//获取密钥
//            console.log(loginPhone);
//            console.log(loginPassword);
//            console.log(authKey);
            var authInfo = {
                "auth":authKey,
                "timestamp":timestamp
            };
            $.ajax({
                type:"POST",
                url:baseUrl + "/apigateway/login",
                dataType:"json",
                data:JSON.stringify(authInfo),
                success:function(data){
                    console.log("登陆",data);
                    if(data.status == 200){
                        data = JSON.parse(data.data);
                        console.log("登陆",data);
                        var token = data.token;
                        localStorage.setItem('token',token);//设置本地存储
                        if(getParamByUrl('goLogin') == 1){
                            //跳转到上个页面
                            window.history.go(-1);
                        }else{
                            window.location.href = "index.html";
                        }
                    }else{
                        commonPopFun1("Sorry,the cellphone number or password is wrong. Please check.", "Failed");
                    }
                },
                error:function(error){
                    console.log(error);
                }
            });
        }


        //注册
        /*#drag*/
        $('.registerDragNew #drag').drag();
        var timer = setInterval(function(){
            if($('#drag .drag_text').text() == "OK"){
                clearInterval(timer);
            }
        }, 500);


        //登陆
        $('#loginBtn').unbind('click').click(function () {
            loginFun();
        });
        var loginRegisterStatus;
        $('#loginPhone, #loginPassword').on('focus',function () {
            loginRegisterStatus = 0;
//            console.log(loginRegisterStatus);
        });
        $('#registerPhone, #registerPassword').on('focus',function () {
            loginRegisterStatus = 1;
//            console.log(loginRegisterStatus);
        });
        //正则验证注册的手机号
        var myReg = /^((9|09)+\d{8})$/;
        var canRegister = true;
        $('#registerPhone').on('blur', function () {
            var regText = $.trim($('#registerPhone').val());
            if(!myReg.test(regText)){
                canRegister = false;
                $('#registerTip').show();

                $('#registerPhone').unbind('blur').bind('input propertychange', function () {
                    var regText = $.trim($('#registerPhone').val());
                    if(!myReg.test(regText)){
                        canRegister = false;
                        $('#registerTip').show();
                    }else{
                        canRegister = true;
                        $('#registerTip').hide();
                    }

                });

            }else{
                canRegister = true;
            }

        });
        document.onkeydown = function(ev){
            ev = ev || event;
            console.log(ev.keyCode);
            if(ev.keyCode == 13){
                if(loginRegisterStatus == 0){ //登陆
                    loginFun();
                }else if(loginRegisterStatus == 1){//注册
                    registerFun();
                }
                return false;
            }
        };

        $('#registerBtn').unbind('click').click(function () {
            registerFun();
        });
        function registerFun(){
            var dragText = $('#drag .drag_text').text();
            var registerPhone = b.encode($.trim($('#registerPhone').val()));
            var registerPassword = b.encode($.trim($('#registerPassword').val()));
            var reg = encrypt.encrypt("user="+ registerPhone +"&pass="+ registerPassword +"&nickname="+ registerPhone);//获取密钥
            var timestamp=new Date().getTime();//获取时间戳
//            console.log(registerPhone);
//            console.log(registerPassword);
//            console.log(reg);
            var authInfo = {
                "reg":reg,
                "timestamp":timestamp
            };
            if(dragText == 'OK'){
                $.ajax({
                    type:"POST",
                    url:baseUrl + "/apigateway/reg",
                    dataType:"json",
                    data:JSON.stringify(authInfo),
                    success:function(data){
                        console.log("注册",data);
                        if(data.status == 200){
                            console.log("注册成功",data);


                            var registerPhone = b.encode($.trim($('#registerPhone').val()));
                            var registerPassword = b.encode($.trim($('#registerPassword').val()));
                            var authKey = encrypt.encrypt("user="+ registerPhone +"&pass="+ registerPassword);//获取密钥
                            var timestamp=new Date().getTime();//获取时间戳
                            var authInfo = {
                                "auth":authKey,
                                "timestamp":timestamp
                            };
                            $.ajax({
                                type:"POST",
                                url:baseUrl + "/apigateway/login",
                                dataType:"json",
                                data:JSON.stringify(authInfo),
                                success:function(data){
                                    console.log("登陆",data);
                                    if(data.status == 200){
                                        data = JSON.parse(data.data);

                                        var token = data.token;
                                        localStorage.setItem('token',token);//设置本地存储
                                        if(getParamByUrl('goLogin') == 1){
                                            //跳转到上个页面
                                            window.history.go(-1);
                                        }else{
                                            window.location.href = "index.html";
                                        }
                                    }else{
                                        commonPopFun1("Sorry,the cellphone number or password is wrong. Please check.", "Failed");
                                    }
                                },
                                error:function(error){
                                    console.log(error);
                                }
                            });


                        }else if(data.status == 500){
                            commonPopFun1("Sorry,this cellphone number was registered. Please use anther one.", "Failed");
                        }else{
                            commonPopFun1("Sorry,failed to register. Please try to register later.", "Failed");
                        }
                    },
                    error:function(error){
                        console.log(error);
                        commonPopFun1("Sorry,failed to register. Please try to register later.", "Failed");
                    }
                });
            }else{
//                alert("请拖拽滑块~");
                $('#drag').css('backgroundColor', 'red');
            }
        }
    });
</script>
</body>
</html>